{% extends "registration/master.html" %}

{% block content %}

{% if orderItems %}

	<div class="tab-content">
	<div role="tabpanel" class="tab-pane fade in active" id="personal">
		<h1>Checkout</h1>
		<h3>Add another attendee to your order, or checkout</h3>
		<hr>

		<h3>Your Order</h3>
			
			<div class="row">
				<div class="col-sm-5 col-sm-offset-1"><h4>Attendee</h4></div>
				<div class="col-sm-2"><h4>Price</h4></div>   
			</div>

		{% for item in orderItems %}
			<div class="row">
				<div class="col-sm-5 col-sm-offset-1">{{item.attendee}} - {{item.priceLevel}}</div>
				<div class="col-sm-2">${{item.priceLevel.basePrice}}</div>   
				<div class="col-sm-2">
					<a class="deleteAttendee" id="delete_{{item.id}}">Remove</a>
				</div>
			</div>
			{% for option in item.getOptions %}
			<div class="row">
				{% if option.option.optionExtraType == "int" %}

				  <div class="col-sm-5 col-sm-offset-1">{{option.option}} x {{option.optionValue}}</div>
				  {% if option.option.optionPrice == 0 %}
				    <div class="col-sm-2">Free</div>
				  {% else %}
				    <div class="col-sm-2">${{option.option.optionPrice}} each</div>
				  {% endif %}

				{% else %}

				  <div class="col-sm-5 col-sm-offset-1">{{option.option}}</div>
				  {% if option.option.optionPrice == 0 %}
				    <div class="col-sm-2">Free</div>
				  {% else %}
				    <div class="col-sm-2">${{option.option.optionPrice}}</div>
				  {% endif %}

				{% endif %}

			</div>
			{% endfor %}
			{% if discount %}
				<div class="row">
					<div class="col-sm-5 col-sm-offset-1">Discount - {{discount.codeName}}</div>
					<div class="col-sm-2">- ${{discount.amountOff}}</div>   
					<div class="col-sm-2">
					</div>
				</div>
			{% endif%}
			<div class="row" style="height:10px;">&nbsp;</div>

		{% endfor %}
			<div class="row">
				<div class="col-sm-5 col-sm-offset-1"><h4>Total</h4></div>
				<div class="col-sm-2"><h4>${{total}}</h4></div>   
			</div>

	
		<br/>
		<a class="btn btn-primary" id="addAnother">Add Another Attendee</a> <a class="btn" id="cancel">Cancel Registraiton</a>

		<hr/>
		{% if total > 0%}

		{% if not discount %}

		<h3>Discount</h3>
		<div class="col-sm-11 col-sm-offset-1" style="padding-left:0px;padding-bottom:10px;">If you have a discount code, enter it below:</div>
		<div class="row">
			<div class="col-sm-11 col-sm-offset-1">
				<div class="form-inline">
				<div class="form-group">
					<label for="discount" class="sr-only">Discount Code</label>
					<input type="text" id="discount" class="form-control" />
				</div>
				<button class="btn btn-primary" id="applyDiscount">Apply</button>
			</div>
		</div>

		
		
		{% endif %}
		<div class="container" style="width: inherit">
		<form class="form-horizontal" role="form" data-toggle="validator">
		
		<h3>Extra Donations</h3>
		<div class="col-sm-11 col-sm-offset-1" style="padding-left:0px;padding-bottom:10px;">If you would like to make an extra gift to our annual charity, Frisky's, or to the convention, please enter it below.</div>
		<div class="form-group">
                    <label for="donateCharity" class="col-sm-3 control-label">Donate to Frisky's</label>
		    <div class="col-sm-4">
			<input type="text" id="donateCharity" class="form-control" placeholder="0.00" />
		    </div>
		</div>
		<div class="form-group">
                    <label for="donateCharity" class="col-sm-3 control-label">Donate to Furthemore</label>
		    <div class="col-sm-4">
			<input type="text" id="donateOrg" class="form-control" placeholder="0.00" />
		    </div>
		</div>
		<hr/>


		<h3>Billing Information</h3>


		<div class="form-group">
                    <label for="useFrom" class="col-sm-3 control-label">Use Billing Info From</label>
                    <div class="col-sm-9">
                        <select id="useFrom" class="form-control" ><option value="" selected>The Fields Below</option>
			{% for oi in orderItems %}
			    <option value="{{oi.attendee.id}}">{{oi.attendee}}</option>
			{% endfor %}
			</select>
                    </div>
		</div>
		<div class="form-group">
                    <label for="billingName" class="col-sm-3 control-label">Billing Name</label>
                    <div class="col-sm-4">
                        <input type="text" id="fname" placeholder="Billing First Name" class="form-control" required data-error="Billing name is required. " />
                    </div>
                    <div class="col-sm-5">
                        <input type="text" id="lname" placeholder="Billing Last Name" class="form-control" required data-error="Billing name is required. " />
                    </div>
		    <div class="col-sm-offset-3 help-block with-errors"style=" padding-left:15px;"></div>
		</div>
		<div class="form-group">
                    <label for="email" class="col-sm-3 control-label">Email</label>
                    <div class="col-sm-9">
                        <input type="email" id="email" placeholder="Email" class="form-control" required data-error="Email is required. " />
                    </div>
		    <div class="col-sm-offset-3 help-block with-errors"style=" padding-left:15px;"></div>
		</div>
		<div class="form-group">
                    <label for="add1" class="col-sm-3 control-label">Billing Address</label>
                    <div class="col-sm-9">
                        <input type="text" name="add1" id="add1" placeholder="Address Line 1" class="form-control" required />
                    </div>
		    <div class="col-sm-offset-3 help-block with-errors"style=" padding-left:15px;"></div>
                </div>
                <div class="form-group">
                    <label for="add2" class="col-sm-3 control-label">&nbsp;</label>
                    <div class="col-sm-9">
                        <input type="text" name="add2" id="add2" placeholder="Address Line 2" class="form-control" />
                    </div>
		    <div class="col-sm-offset-3 help-block with-errors"style=" padding-left:15px;"></div>
                </div>
                <div class="form-group">
                    <label for="city" class="col-sm-3 control-label">City/State/ZIP</label>
		    <div class="col-sm-4">
			<input type="text" name="city" id="city" placeholder="City" class="form-control" required data-error="City is required." />
		    </div>
                    <div class="col-sm-2">
			<select class="form-control bfh-states" id="state" data-country="US" data-state="VA" name="state"></select>
                    </div>
		    <div class="col-sm-3">
			<input type="text" name="zip" id="zip" placeholder="ZIP Code" class="form-control" data-minlength="5" data-error="Zip code is required." />
		    </div>
		    <div class="col-sm-offset-3 help-block with-errors"style=" padding-left:15px;"></div>
                </div>
                <div class="form-group">
                    <label for="country" class="col-sm-3 control-label">Country</label>
                    <div class="col-sm-9">
			<select id="country" class="form-control bfh-countries" data-country="US" name="country"></select>
                    </div>
		</div>
	<hr/>
		<div class="form-group">
                    <label for="ccNumber" class="col-sm-3 control-label">Credit Card Number</label>
                    <div class="col-sm-9">
                        <input type="text" name="ccNumber" id="ccNumber" class="form-control" maxlength="16" required />
                    </div>
		    <div class="col-sm-offset-3 help-block with-errors"style=" padding-left:15px;"></div>
                </div>
		<div class="form-group">
                    <label for="ccMonth" class="col-sm-3 control-label">Expiration Date</label>
                    <div class="col-sm-2">
			<select id="ccMonth" class="form-control" required>
				<option value="01">01</option>
				<option value="02">02</option>
				<option value="03">03</option>
				<option value="04">04</option>
				<option value="05">05</option>
				<option value="06">06</option>
				<option value="07">07</option>
				<option value="08">08</option>
				<option value="09">09</option>
				<option value="10">10</option>
				<option value="11">11</option>
				<option value="12">12</option>
			</select>
                    </div>
                    <div class="col-sm-2">
			<select id="ccYear" class="form-control" required>
				<option value="2017">2017</option>
				<option value="2018">2018</option>
				<option value="2019">2019</option>
				<option value="2020">2020</option>
				<option value="2021">2021</option>
				<option value="2022">2022</option>
				<option value="2023">2023</option>
				<option value="2024">2024</option>
			</select>
                    </div>
                    <label for="ccCVV" class="col-sm-2 control-label">CVV</label>
		    <div class="col-sm-3">
                        <input type="text" id="ccCVV" class="form-control" maxlength="4" required data-error="CVV is required" />
                    </div>
		    <div class="col-sm-offset-3 help-block with-errors"style=" padding-left:15px;"></div>
		</div>

		{% csrf_token %}
		<!-- <div class="form-group" style="margin-right:0px;"> -->
			<button class="btn btn-primary col-sm-3 col-sm-offset-9 mobile-block" style="padding-right:10px;" id="checkout">Checkout</button>
		<!-- </div> -->
 		</form>
		</div>
		

		{% else %}

			{% csrf_token %}
			<div class="row">
				<a class="btn btn-primary col-sm-3 col-sm-offset-9" id="checkout">Checkout</a>
			</div>

		{% endif %}

	</div>
	</div>
{% else %}

	<div class="tab-content">
	<div role="tabpanel" class="tab-pane fade in active" id="personal">
		<h1>Checkout</h1>
		<h3>There are no attendees in your order</h3>
		<hr>
		<a class="btn btn-primary" href="/apis/registration/">Add Attendee</a>


	</div>
	</div>

{% endif %}

{% endblock %}


{% block javascript %}
<script type="text/javascript">
	var addresses = [];
	$( "body" ).ready(function() {
                $.getJSON("/apis/registration/addresses", function(data) {
		addresses = data;
                });		
	});

	$(".deleteAttendee").click(function(e) {
		var id = this.id.split('_')[1];
		var data = {'id': id}
		$.ajax({
		    "type": "POST",
		    "dataType": "json",
		    "url": "/apis/registration/cart/remove/",
		    "data": JSON.stringify(data),
		    "beforeSend": function(xhr, settings) {
		        console.log("Before Send");
		        $.ajaxSettings.beforeSend(xhr, settings);
		    },
		    "error": function(result, status, error) {
                        alert("An error has occurred. If this error continues, please contact registration@furthemore.org for assistence.")
		    },
                    "success": function (result, status) {
                        if (result.success) {
				window.location.reload();
                        } else {
                            alert("An error has occurred: " + result.message + " If this error continues, please contact registration@furthemore.org for assistence.");
			}
                    }
		});
	});

	$("#addAnother").click(function() {
		window.location = "/apis/registration";
	});

	$("#cancel").click(function() {
		var cancel = window.confirm("Are you sure you want to cancel your registration? This will remove all attendees from your order.")
		if (cancel == false) { return;}
		
                $.getJSON("/apis/registration/cart/abandon", function(data) {
			window.location = "/apis/registration";
                });
	});

	$("#applyDiscount").click(function(e) {
		var discount = $("#discount").val();
		if (discount == '') {
			alert("You must enter a discount to apply.");
			return;
		}
		var data = {'discount': discount}
		$.ajax({
		    "type": "POST",
		    "dataType": "json",
		    "url": "/apis/registration/cart/discount/",
		    "data": JSON.stringify(data),
		    "beforeSend": function(xhr, settings) {
		        console.log("Before Send");
		        $.ajaxSettings.beforeSend(xhr, settings);
		    },
		    "error": function(result, status, error) {
                        alert("An error has occurred. If this error continues, please contact registration@furthemore.org for assistence.")
		    },
                    "success": function (result, status) {
                        if (result.success) {
				window.location.reload();
                        } else {
                            alert("An error has occurred: " + result.message + " If this error continues, please contact registration@furthemore.org for assistence.");
			}
                    }
		});

		
	});

	$("#useFrom").on("change", function(e) {
		var userId = $(this).val();
		if (userId == ""){
			$("#fname").val("");
			$("#lname").val("");
			$("#email").val("");
			$("#add1").val("");
			$("#add2").val("");
			$("#city").val("");
			$("#state").val("");
			$("#country").val("");
			$("#zip").val("");
			return;
		}

		var userName = $("#useFrom option[value='" + userId + "']").text();
		$("#fname").val(userName.split(' ')[0]);
		$("#lname").val(userName.split(' ')[1]);
		$.each(addresses, function (key, item) {
			if (item.id != userId) { return; }
			$("#email").val(item.email);
			$("#add1").val(item.address1);
			$("#add2").val(item.address2);
			$("#city").val(item.city);
			$("#state").val(item.state);
			$("#country").val(item.country);
			$("#zip").val(item.postalCode);
		});
	});

	$("#checkout").click(function (e) {
		e.preventDefault();
		$("form").validator('validate');
		var errorCount = $(".has-error").length;
		if (errorCount > 0) {return;}

		$("#checkout").attr("disabled", "disabled");

		{% if total > 0 %}
		var data = {
            'onsite': false,
		    'billingData': {
			'cc_number': $("#ccNumber").val(), 'cc_month': $("#ccMonth").val(), 
			'cc_year': $("#ccYear").val(), 'cc_security': $("#ccCVV").val(),
			'cc_firstname': $("#fname").val(), 'cc_lastname': $("#lname").val(), 'email': $("#email").val(),
                        'address1': $("#add1").val(), 'address2': $("#add2").val(), 'city': $("#city").val(),
                        'state': $("#state").val(), 'country': $("#country").val(), 'postal': $("#zip").val(),
		    },
		    'charityDonation': $("#donateCharity").val(),
		    'orgDonation': $("#donateOrg").val()
		};
		{% else %}
		var data = {};

		{% endif %}

		$.ajax({
		    "type": "POST",
		    "dataType": "json",
		    "url": "/apis/registration/cart/checkout/",
		    "data": JSON.stringify(data),
		    "beforeSend": function(xhr, settings) {
		        console.log("Before Send");
		        $.ajaxSettings.beforeSend(xhr, settings);
		    },
		    "error": function(result, status, error) {
                        alert("An error has occurred. If this error continues, please contact registration@furthemore.org for assistence.")
			$("#checkout").removeAttr("disabled");
		    },
                    "success": function (result, status) {
                        if (result.success) {
				window.location = "/apis/registration/cart/done/";
                        } else {
                            alert("An error has occurred: " + result.message + " If this error continues, please contact registration@furthemore.org for assistence.");
			    $("#checkout").removeAttr("disabled");
			}
                    }
		});


	});


function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            // Only send the token to relative URLs i.e. locally.
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
    }
});

</script>
{% endblock %}
