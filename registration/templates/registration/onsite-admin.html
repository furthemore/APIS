{% extends "registration/master_admin.html" %}
{% load admin_urls static %}

{% block content %}


    <div class="row">
        <div class="col-md-6">
            <h2><a href="{% url 'registration:onsiteAdmin' %}">APIS Register</a></h2>
        </div>
        <div class="col-md-2 col-md-offset-2 col-top">
            <form class="form-inline" id="terminal_form" method="get">
                <label for="pos" class="sr-only">Register Position</label>
                <select class="form-control" id="pos" name="terminal">
                {% for terminal in terminals %}
                  {% if request.session.terminal == terminal.id %}
                    <option selected value="{{ terminal.id }}">{{ terminal.name }}</option>
                  {% else %}
                    <option value="{{ terminal.id }}">{{ terminal.name }}</option>
                  {% endif %}
                {% endfor %}
                </select>
            </form>
        </div>
        <div class="col-md-1 col-top">
            <div class="dropdown">
                <button id="user" type="button" class="btn btn-default" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-cog"></i><span class="sr-only">Terminal options</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="user">
                    <li><a href="#" id="open-terminal">Open Position <i class="fas fa-check right"></i></a></li>
                    <li><a href="#" id="close-terminal">Close Position <i class="fas fa-window-close right"></i></a></li>
                </ul>
            </div>
        </div>
        <div class="col-md-1 col-top">
            <div class="dropdown">
                <button id="user" type="button" class="btn btn-default" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user"></i><span class="sr-only">User options</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="user">
                    <li><a href="{% url 'registration:logout' %}?next={% url 'registration:onsiteAdmin' %}">Sign Out <i class="fas fa-sign-out-alt right"></i></a></li>
                </ul>
            </div>
        </div>
    </div>

    <hr>

    {% for error in errors %}
    <div class="alert alert-{{ error.type }}" role="alert">{{ error.text }}</div>
    {% endfor %}

    <div class="alert alert-danger" id="client-error">
      <i class="fas fa-exclamation-triangle"></i>
      <span class="sr-only">Error:</span>
      <b>There was a problem while connecting to the server.</b>
       <a class="alert-link" href="{% url 'registration:onsiteAdmin' %}">Reload</a>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="row">
          <div class="col-md-12">
            <form class="form-inline my-lg-0" action="{% url 'registration:onsiteAdmin' %}" method="get">
                <input type="hidden" id="terminal" name="terminal" value="{{ request.session.terminal }}">
                <input class="form-control mr-sm-2" type="text" placeholder="Search attendee"
                    autofocus="autofocus" autocomplete="off" name="search">
                <button class="btn btn-secondary my-2 my-sm-0" type="submit">
                    Search <i class="fas fa-search"></i>
                </button>
                <a href="{% url 'registration:onsite' %}" class="btn btn-success my-2 my-sm-0" target="_blank">
                    Add Attendee <i class="fas fa-plus-circle"></i>
                </a>
            </form>
          </div>
        </div>
        <div class="row">
          <div class="panel panel-default">
            <div class="panel-heading">Search results</div>

            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Legal Name</th>
                  <th>Preferred Name</th>
                  <th>Badge Name</th>
                  <th>Status</th>
                  <th><span class="sr-only">Action</span></th>
                </tr>
              </thead>
              <tbody>
              {% for badge in results %}
                <tr>
                  <td class="results">{{ badge.attendee.firstName }} {{ badge.attendee.lastName }}</td>
                  <td class="results">{{ badge.attendee.preferredName }}</td>
                  <td class="results">{{ badge.badgeName }}</td>
                  <td>{{ badge.abandoned }}</td>
                  <td style="text-align: right">
                    <a target="_blank" href="{% url 'admin:registration_badge_change' badge.id %}" class="btn btn-info" title="Edit attendee"><i class="fas fa-edit"></i></a>
                      <a href="#" class="btn btn-success add-badge" data-id="{{ badge.id }}" title="Add {{ badge.attendee.firstName }} to cart"><i class="fas fa-plus"></i></a>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="well">
        <div class="alert alert-danger" id="cart-error" role="alert">
          An error occurred.
        </div>
          <div class="row"><div class="col-md-8">
            <h2>Cart&nbsp;
              <a id="refresh_button" href="#" title="Refresh">
                <i class="fas fa-sync"></i><span class="sr-only">Refresh</span>
              </a>
            </h2>
          </div><div class="col-md-4" style="margin-top: 20px">
            <a href="{% url 'registration:onsiteAdminClearCart' %}?terminal={{ request.session.terminal }}&search={{ request.GET.search }}" class="btn btn-danger right">Clear</a>
          </div></div>
          <div id="cart"></div>
          <div class="total" id="total"></div>

            <div class="row button-group">
                <div class="col-md-6">
                    {% if perms.registration.cash %}
                    <button class="btn btn-block btn-primary" id="cash_button" disabled>
                        <i class="fas fa-money-bill-alt"></i> Tender Cash
                    </button>
                  {% endif %}
                </div>
                <div class="col-md-6">
                    <button class="btn btn-block btn-warning" id="credit_button" disabled>
                        <i class="fas fa-credit-card"></i> Credit/Debit
                    </button>
                </div>
            </div>
            <div class="row button-group">
              <div class="col-md-6">
                <button class="btn btn-block btn-primary" id="print_button" disabled>
                  <i class="fas fa-print"></i> Print Badges
                </button>
              </div>

              <div class="col-md-6">
                <button class="btn btn-block btn-primary" id="print_preview" disabled>
                  <i class="fas fa-file-pdf"></i> Print Preview
                </button>
              </div>
            </div>

            {% if perms.registration.discount %}
            <div class="row">
              <div class="col-md-6">
                <button class="btn btn-block btn-primary" id="receipt_button" disabled>
                  <i class="fas fa-receipt"></i> Print Receipt
                </button>
              </div>

                <div class="col-md-6">
                <button class="btn btn-block btn-danger" id="discount_button">
                    <i class="fas fa-tag"></i> Discount
                </button>
                </div>
            </div>
          {% else %}
            <div class="row">
              <div class="col-md-12">
                <button class="btn btn-block btn-primary" id="receipt_button" disabled>
                  <i class="fas fa-receipt"></i> Print Receipt
                </button>
              </div>
            </div>
          {% endif %}

        </div>
      </div>
    </div>

    <style>
        .well, .panel {
            margin-top: 20px;
        }

        #refresh_button {
            font-size: 50%;
        }

        #pos {
            width: 100%;
        }

        .price-line {
            font-weight: bold;
            font-size: 1.2em;
        }

        .price-line::before {
            content: '$';
        }

        .age {
            float: right;
        }

        .right {
            float: right;
        }

        .cart-table td {
            font-size: 1.6em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .results {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        .total {
            margin-bottom: 22px;
        }

        .button-group {
            margin-bottom: 20px;
        }

        .total-table {
            font-size: 22px;
            width: 100%;
        }

        .total-table td {
            padding-right: 10px;
        }

        .total-table tr td:nth-child(1) {
            float: right;
        }

        .remove-badge {
            color: darkred;
            float: right;
            padding-left: 10px;
        }

        .col-top {
            margin-top: 20px;
        }

        #client-error {
            display: none;
        }

        #cart-error {
            display: none;
        }
    </style>

  <script type="text/html" id="itemRowTemplate">
    <tr>
      <td><span data-content="quantity"></span> &times; <span data-content="item"></span> (@<span data-content="price"></span>)</td>
      <td><span data-content="total"></span></td>
    </tr>
  </script>

  <script type="text/html" id="cartTemplate">
    <div class="panel panel-default">
      <div class="panel-heading">
        <span data-content="abandoned" data-format="PaidBadgeFormatter"></span>
        <span data-content="holdType" data-format="HoldTypeFormatter"></span>
        <span data-content="printed" data-format="PrintedBadgeFormatter"></span>
        <a class="link-badge" href="#" data-id="delete_id"><span data-content="name"></span></a>
        <a class="remove-badge" href="#" data-id="delete_id"><i class="fas fa-minus-circle"></i></a>
        <span data-content="age" data-format="MinorFormFormatter" class="age"></span>
      </div>
      <table class="table cart-table">
        <thead>
          <tr data-class="state">
            <th>Badge Name</th>
            <th>Level</th>
            <th>Price</th>
           </tr>
        </thead>
        <tbody>
          <tr data-class="state">
            <td data-content="badgeName"></td>
            <td data-content="level"></td>
            <td><span class="price-line" data-content="price"></span></td>
          </tr>
        </tbody>
      </table>
      <table class="table">
        <thead>
          <tr data-class="state">
            <th>Order Item</th>
            <th>Price</th>
           </tr>
        </thead>
        <tbody data-id="items_id"></tbody>
      </table>
    </div>
  </script>

  <script type="text/html" id="totalTemplate">
    <table class="total-table">
      <tr>
        <td>Subtotal:</td>
        <td>$<span data-content="subtotal"></span></td>
      </tr>
      <tr>
        <td>Discounts:</td>
        <td>-$<span data-content="total_discount"></span></td>
      </tr>
      <tr>
        <td>Donation to Charity:
        <td>$<span data-content="charityDonation"></span>
      </tr>
      <tr>
        <td>Donation to Convention:
        <td>$<span data-content="orgDonation"></span>
      </tr>
      <tr>
        <td><b>Total:</b>
        <td class="success"><b>$<span data-content="total"></span></b>
      </tr>
    </table>
  </script>
{% endblock %}

{% block javascript %}
<script>
var URL_REGISTRATION_ASSIGN_BADGE_NUMBER = "{% url 'registration:assignBadgeNumber' %}";
var URL_REGISTRATION_ONSITE_PRINT_BADGES = "{% url 'registration:onsitePrintBadges' %}";
var URL_REGISTRATION_ONSITE_ADMIN_CLEAR_CART = "{% url 'registration:onsiteAdminClearCart' %}";
var URL_REGISTRATION_ONSITE_ADMIN_CART = "{% url 'registration:onsiteAdminCart' %}";
var URL_REGISTRATION_ONSITE_ADMIN_ADD_TO_CART = "{% url 'registration:onsiteAddToCart' %}";
var URL_REGISTRATION_ONSITE_REMOVE_FROM_CART = "{% url 'registration:onsiteRemoveFromCart' %}";
var URL_REGISTRATION_OPEN_TERMINAL = "{% url 'registration:openTerminal' %}";
var URL_REGISTRATION_CLOSE_TERMINAL = "{% url 'registration:closeTerminal' %}";
var URL_REGISTRATION_ENABLE_PAYMENT = "{% url 'registration:enablePayment' %}";
var URL_REGISTRATION_COMPLETE_CASH_TRANSACTION = "{% url 'registration:completeCashTransaction' %}";
var URL_ADMIN_REGISTRATION_BADGE = "{% url 'admin:registration_badge_change' 0 %}";
var URL_REGISTRATION_ONSITE_ADMIN_CREATE_DISCOUNT = "{% url 'registration:onsite_create_discount' %}";
</script>

<script src="{% static 'js/onsite_admin.js' %}"></script>
{% endblock %}
