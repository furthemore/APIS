{% extends "registration/master.html" %}

{% load registration_tags %}

{% block content %}

<div class="modal fade" id="ageModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Why do we need your birthdate?</h4>
      </div>
      <div class="modal-body">
    	<p>Staff must be over the age of 18.</p>
	    <p>Please contact <a href="mailto:{{ event.staffEmail }}">{{ event.staffEmail }}</a> if you have any questions.</p>
      </div>
    </div>
  </div>
</div>

    {% if not token %}
		<h1>New Staff Registration <br/>{{event}}</h1>
        <p>Your session has expired. Please use the link in your registration email again to start over.</p>
    {% else %}

	<form class="form-horizontal" role="form" data-toggle="validator">
	<div class="tab-content">
	<div role="tabpanel" class="tab-pane fade in active" id="personal">
		<h1>New Staff Registration <br/>{{event}}</h1>

		<p>Please review and update the information below. If you have any questions about this form, please contact <a href='mailto:{{ event.staffEmail }}'>{{ event.staffEmail }}</a>. Required fields are marked with a red asterisk (<span style="color:red;">*</span>)</p>

        {% show_attendee_form event=event %}

        {% show_staff_form staff %}

        <hr/>
        <h3>Badge Level</h3>
        <br/>
        {% show_price_types %}
        <br/>
        <hr/>

            <div class="form-group">
                <div class="col-sm-12">
                    <input type="checkbox" id="agreeToRules" name="agreeToRules" class="form-control form-control-checkbox" required />
			        I agree to abide by {{event}}'s <a href="{{ event.codeOfConduct }}">Code of Conduct.</a>
                </div>
		        <div class="col-sm-offset-1 help-block with-errors" style="padding-left:15px;"></div>
		    </div>
		    <div class="form-group">
                 <div class="col-sm-12">
                    <button id="register" type="submit" class="btn btn-primary col-sm-6 col-sm-offset-6" aria-controls="profile" data-toggle="tab">Register</button>
		        </div>
            </div>
	    </div>
	</div>
	{% csrf_token %}
	</div>
	</form>

    {% endif %}

{% endblock %}

{% block javascript %}
<script>
    var discount = {{event.newStaffDiscount.amountOff}}
    var adult = true;
</script>
<script type="text/javascript" src="/static/js/templates/price-types.js"></script>
<script type="text/javascript" src="/static/js/templates/staff.js"></script>
 <script type="text/javascript">

	function doRegister(e) {
		e.preventDefault();
		$("form").validator('validate');
		var errorCount = $(".has-error").length;
		if (errorCount > 0) {
            $(this).one(doRegister)
            return;
        }

        // Validate birthdate input
        if ($("#birthDate").val() == "") {
            alert("You must enter your birthdate to submit your registration.");
            $(this).one(doRegister)
            return;
        }
        if (Modernizr.inputtypes.date) {
            // native datepicker - expect ISO date
            var birthdate = parseDate($("#birthDate").val());
        } else {
            // American middle-endian format put out by datepicker javascript
            var birthdate = new Date(Date.parse($("#birthDate").val()));
        }
        var age = getAge(birthdate);
        if (age < 18) {
            alert("You must be 18 by the first day of the event to register online.");
            $(this).one(doRegister)
            return;
        }

		$("#register").attr("disabled", "disabled");

		var data = {
			'attendee': {
				'firstName': $("#firstName").val(), 'lastName': $("#lastName").val(), 'preferredName': $("#preferredName").val(),
				'address1': $("#add1").val(), 'address2': $("#add2").val(), 'city': $("#city").val(),
				'state': $("#state").val(), 'country': $("#country").val(), 'postal': $("#zip").val(),
				'birthdate' : $("#birthDate").val(), 'phone': $("#phone").val(),
                'email':$("#email").val(), 'badgeName': $("#badgeName").val()
			},
			'staff': {
				'twitter': $("#twitter").val(), 'telegram': $("#telegram").val(),
				'shirtsize': $("#shirt").val(), 'specialSkills': $("#skills").val(),
				'specialFood': $("#food").val(), 'specialMedical': $("#medical").val(),
				'contactPhone': $("#contactPhone").val(), 'contactName': $("#contactName").val(),
				'contactRelation': $("#contactRel").val(),
			},
            'priceLevel': { 'id': $(".selectLevel")[0].id.split('_')[1], 'options': getOptions() },
            'event': '{{event}}'
		};


		$.ajax({
		    "type": "POST",
		    "dataType": "json",
		    "url": "{% url 'registration:addNewStaff' %}",
		    "data": JSON.stringify(data),
		    "beforeSend": function(xhr, settings) {
		        console.log("Before Send");
		        $.ajaxSettings.beforeSend(xhr, settings);
		    },
		    "error": function(result, status, error) {
			    if (result.responseText == "") {
				    alert("Your session has expired.");
			    } else {
                    alert("An error has occurred. Please check the form for any error messages. If this error continues, please contact {{ event.staffEmail }} for assistance.")
			    }
			    $("#register").removeAttr("disabled").one(doRegister);
		    },
            "success": function (result, status) {
                if (result.success)
                {
 	                window.location = "{% url 'registration:cart' %}";
			    } else {
                    alert("An error has occurred. Please check the form for any error messages. If this error continues, please contact {{ event.staffEmail }} for assistance.")
			    }
			    $("#register").removeAttr("disabled").one(doRegister);
            }
		});
	}


    $("#register").one(doRegister);

 </script>

 <script type="text/javascript">
function daysInMonth(month, year) {
  return new Date(year, month, 0).getDate();
}

$('#byear, #bmonth').change(function() {

  if ($('#byear').val().length > 0 && $('#bmonth').val().length > 0) {
    $('#bday').prop('disabled', false);
    $('#bday').find('option').remove();

    var daysInSelectedMonth = daysInMonth($('#bmonth').val(), $('#byear').val());

    for (var i = 1; i <= daysInSelectedMonth; i++) {
      $('#bday').append($("<option></option>").attr("value", i).text(i));
    }

  } else {
    $('#bday').prop('disabled', true);
  }

});</script>

{% endblock %}
